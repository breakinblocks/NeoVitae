# Neo Vitae Changelog

This document tracks all changes made from the original Blood Magic 1.20.1 codebase during the migration and rewrite to NeoForge 1.21.1.

---

## Documentation System

### Patchouli to Modopedia Migration
- Removed Patchouli dependency entirely
- Added Modopedia as required dependency via CurseMaven
- Converted all 210 guide book files (1 book, 21 categories, 188 entries) to Modopedia format
- Created custom `MultiblockValidator` class for altar tier validation (decoupled from book mod)
- Added `ModopediaCompat` class to register altar multiblocks with Modopedia for in-book visualization
- Added `ClientForgeEventHandler` to handle client-side multiblock registration timing

---

## Build System

### Gradle Updates
- Updated to NeoForge for 1.21.1
- Added CurseMaven repository for Modopedia dependency
- Updated `gradle.properties` with Modopedia file ID instead of Patchouli version

### JEI Compatibility
- Updated JEI version from 19.8.2.99 to 19.25.1.332
- Fixed mc_version property (1.21 → 1.21.1) for correct JEI artifact resolution
- Resolves ClassNotFoundException for `mezz.jei.api.ingredients.subtypes.ISubtypeInterpreter`

### Mod Metadata
- Updated `neoforge.mods.toml` dependencies (patchouli → modopedia)

---

## Datagen Improvements

### Recipe Builder Validation
- Added validation to `AlchemyTableRecipeBuilder` - max 6 inputs, non-empty output required
- Added validation to `AlchemyArrayRecipeBuilder` - requires both base and added inputs
- Added validation to `ARCRecipeBuilder` - requires input, at least one output (item or fluid)
- Added validation to `AltarRecipeBuilder` - requires input ingredient and positive blood cost
- Added validation to `ForgeRecipeBuilder` - max 4 ingredients, at least 1 required
- All builders now throw `IllegalStateException` or `IllegalArgumentException` on invalid recipes

### Recipe Corrections
- Fixed `RecipeCategory` for functional blocks (Blood Altar, Hellfire Forge, Teleposer, Alchemy Table) - changed from DECORATIONS to MISC
- Fixed Hellfire Forge recipe - uses blank slate + obsidian instead of weak blood orb
- Fixed Bloodstone recipe - uses weak blood shard instead of life essence bucket
- Fixed Hellforged Block recipe - uses hellforged ingot (item already existed)
- Fixed Synthetic Point recipe - uses rotten flesh, spider eyes, and saturated tau
- Fixed Orb Rune recipe pattern - stones in corners, runes on sides
- Fixed Ritual Stone recipe pattern - obsidian in corners, slates in center
- Removed Crystal Cluster crafting recipe (obtained differently)
- Updated all 70+ `unlockedBy` calls to use `getHasName()` instead of manual strings

---

## Block and Item Changes

### Sigils
- Added Willful Stone transmutation recipes for all sigil types
- Updated sigil model rotations for better GUI display

---

## Registry System

### Altar Tiers
- Altar tier definitions moved to data-driven JSON format
- Tiers loaded from `data/bloodmagic/bloodmagic/altar_tier/` directory
- Custom `AltarTier` and `AltarComponent` record classes for deserialization

---

## Rendering

### Block Entity Renderers
- Added `AlchemyArrayRenderer.java` - Custom renderer for alchemy array textures
  - Shows base array texture when first item is placed
  - Shows recipe-specific texture when both items are present
  - Supports directional rotation based on tile state
  - Adds subtle rotation animation when array is actively crafting

### Item Models
- Updated item model format for 1.21.1 compatibility
- Adjusted GUI rotation values for various items

---

## Ritual System

### Core Infrastructure
- Complete ritual system rewritten for NeoForge 1.21
- `Ritual.java` abstract base class for all rituals
- `RitualComponent.java` for rune position definitions
- `AreaDescriptor.java` for effect area definitions (AABB, cross, hemispherical)
- `IMasterRitualStone.java` and `MasterRitualStoneTile.java` for ritual activation
- `RitualRegistry.java` using DeferredRegister for ritual registration

### Rituals Implemented (28 Perfect Rituals)
- RitualWater, RitualLava, RitualGreenGrove, RitualJumping
- RitualWellOfSuffering, RitualFeatheredKnife, RitualRegeneration
- RitualHarvest, RitualMagnetic, RitualCrusher, RitualFullStomach
- RitualInterdiction, RitualContainment, RitualSpeed, RitualSuppression
- RitualExpulsion, RitualZephyr, RitualUpgradeRemove, RitualArmourEvolve
- RitualForsakenSoul, RitualCrystalHarvest, RitualPlacer, RitualFelling
- RitualPump, RitualAltarBuilder, RitualPortal, RitualMeteor, RitualDowngrade

### Imperfect Rituals (4)

---

## Meteor Recipe System

### New Data-Driven Meteor System
- Created `MeteorRecipe` class with Codec-based serialization for data-driven meteor definitions
- Created `MeteorSerializer` for recipe type registration
- Registered `neovitae:meteor` recipe type and serializer
- Created helper classes for meteor block generation:
  - `RandomBlockContainer` - base class for random block selection
  - `StaticBlockContainer` - returns a specific block
  - `FluidBlockContainer` - returns block form of a fluid
  - `RandomBlockTagContainer` - selects random block from a tag
  - `MeteorLayer` - defines spherical layers with weighted block selection

### Meteor Generation Features
- Spherical layer-based generation with configurable radii
- Weighted block selection with fill blocks and shell blocks
- Support for block tags, static blocks, and fluids
- Explosion on impact (configurable radius)
- LP cost for ritual activation

### Updated Ritual System
- `EntityMeteor` now reads from meteor recipes to spawn blocks on impact
- `RitualMeteor` now searches for item catalysts and matches them to meteor recipes
- Meteor spawns at max build height and falls with custom gravity

### Default Meteor Recipes
- Iron Block Meteor: Iron ores with copper, gold, lapis, redstone (1M LP, radius 14 explosion)
- Stone Meteor: Large meteor with coal and iron ores (1M LP, radius 30 explosion)
- Diamond Meteor: Small but diamond-rich with emeralds (1M LP, radius 8 explosion)
- Nether Meteor: Nether materials with ancient debris core (1M LP, radius 12 explosion)

### JEI Integration
- `MeteorRecipeCategory.java` - JEI recipe category for meteor recipes
  - Displays catalyst input item (what to drop in ritual)
  - Shows all possible output blocks with weights
  - Displays LP cost, explosion radius, and max meteor radius
  - Fill blocks show "Fill Block" tooltip, weighted blocks show their weight
- Master Ritual Stone registered as recipe catalyst
- Lang keys added: `jei.bloodmagic.recipe.meteor`, `.meteor.fill`, `.meteor.weight`

### Recipe Format Example
```json
{
  "type": "neovitae:meteor",
  "input": { "tag": "c:storage_blocks/iron" },
  "syphon": 1000000,
  "explosion": 14.0,
  "layers": [
    {
      "radius": 4,
      "fill": "minecraft:iron_ore",
      "shell": "minecraft:cobblestone",
      "weighted": [
        { "entry": "minecraft:gold_ore", "weight": 30 }
      ]
    }
  ]
}
```
- ImperfectRitualNight, ImperfectRitualRain, ImperfectRitualResistance, ImperfectRitualZombie

### Harvest Handlers
- IHarvestHandler interface for crop harvesting
- HarvestHandlerPlantable (with Mystical Agriculture compatibility)
- HarvestHandlerStem, HarvestHandlerTall

---

## Demon Will System

### Core Interfaces
- `IDemonWill.java` - Interface for items containing demon will
- `IDemonWillGem.java` - Interface for items storing demon will
- `DemonWillHolder.java` - Multi-type will container with serialization
- `PlayerDemonWillHandler.java` - Helper for managing player will across inventory

### Monster Souls
- `MonsterSoulItem.java` - Dropped by mobs killed with sentient weapons
- Five types: Raw, Corrosive, Destructive, Vengeful, Steadfast

### Sentient Tools
- `SentientSwordItem.java` - Will-powered sword with scaling damage
- `SentientAxeItem.java` - Will-powered axe with dig speed bonus
- `SentientPickaxeItem.java` - Will-powered pickaxe with dig speed bonus
- `SentientShovelItem.java` - Will-powered shovel with dig speed bonus
- `SentientScytheItem.java` - Will-powered scythe with area attacks

### Soul Snare System
- `SoulSnareItem.java` - Throwable item that marks mobs
- `SoulSnareEntity.java` - Projectile entity
- `BMEntities.java` - Entity registry
- Mobs with Soul Snare effect drop demon will on death

### Will Event Handler
- `WillEventHandler.java` - Handles soul drops from sentient weapons and snared mobs
- Looting enchantment support for bonus drops

### Data Components
- `SENTIENT_SWORD_DAMAGE` - Stores sword damage bonus
- `SENTIENT_SWORD_DRAIN` - Stores will drain per swing
- `SENTIENT_SWORD_STATIC_DROP` - Base soul drop amount
- `SENTIENT_SWORD_DROP` - Random soul drop amount
- `SENTIENT_TOOL_SPEED` - Dig speed bonus for tools

### Tool Tier
- Added SENTIENT tier to BMMaterialsAndTiers
- Repair with demon crystals

---

## Will Aura Network

### Chunk-Based Will Storage
- `WillChunk.java` - Data attachment for storing will per chunk
- Each will type (Raw, Corrosive, Destructive, Vengeful, Steadfast) stored separately
- Max 100 will per type per chunk
- Codec-based serialization via NeoForge data attachments

### World Handlers
- `WorldDemonWillHandler.java` - Helper class for all chunk will operations
- Add/drain will from chunks
- Transfer will between adjacent chunks
- Query dominant will type in a chunk

### Demon Crucible
- `DemonCrucibleTile.java` / `DemonCrucibleBlock.java`
- Burns demon will items to release will into chunk aura
- Handles tartaric gems (gradual drain), monster souls (immediate), crystals (threshold-based)
- Item capability for automation

### Demon Pylon
- `DemonPylonTile.java` / `DemonPylonBlock.java`
- Transfers will between adjacent chunks (cardinal directions only)
- All 5 will types transferred simultaneously
- Enables will distribution across the world

### Demon Crystallizer
- `DemonCrystallizerTile.java` / `DemonCrystallizerBlock.java`
- Consumes will from aura to grow demon crystal clusters
- First crystal costs 100 will, additional crystals cost 45 each
- Max 7 crystals tall per crystallizer
- Crystal type matches dominant will in chunk

### Demon Will Aura Gauge
- `DemonWillGaugeItem.java` - Item that enables HUD display
- `DemonWillGaugeOverlay.java` - HUD overlay showing will levels
- Displays colored bars for all 5 will types (Raw, Corrosive, Destructive, Vengeful, Steadfast)
- Hold shift to see exact numerical values (0-100 per type)
- Registered via `RegisterGuiLayersEvent` in NeoForge 1.21

---

## Sigil System

### Base Infrastructure
- `ISigil.java` interface for sigil functionality
- `SigilToggleableItem.java` for toggle-based sigils
- `SigilHoldingItem.java` for sigil of holding

### Sigils Implemented
- Divination Sigil, Seer Sigil
- Water Sigil, Lava Sigil, Void Sigil
- Green Grove Sigil, Air Sigil
- Blood Light Sigil, Fast Miner Sigil
- Magnetism Sigil, Frost Sigil
- Suppression Sigil, Holding Sigil, Teleposition Sigil

### Blood Light System (Fully Implemented)
- `BloodLightBlock.java` - Temporary light source that fades over time
  - Light level scales with lifespan (1-16)
  - Lasts ~5 minutes, fading gradually
  - No collision, invisible render, replaceable
- `EntityBloodLight.java` - Thrown projectile for ranged light placement
  - Red dust particles trail
  - Very low gravity for gentle floating
  - Places light on impact with block or after timeout
- `ItemSigilBloodLight.java` - Updated to use new block/entity
  - Right-click on block: place light directly
  - Right-click at sky: throw light projectile

### Fluid Suppression System (Fully Implemented)
- `SpectralBlock.java` - Invisible placeholder block for suppressed fluids
  - No collision, transparent, replaceable
  - Block entity stores original fluid state
- `SpectralBlockTile.java` - Tracks original fluid and expiration
  - Duration countdown (default 40 ticks / 2 seconds)
  - Restores original fluid when duration expires
  - Can be refreshed by nearby sigil
- `ItemSigilSuppression.java` - Suppresses fluids in 5-block radius
  - Scans area around player each tick
  - Replaces fluids with spectral blocks
  - Keeps refreshing nearby spectral blocks while active
  - Fluids restore automatically when player leaves area

### Sigil of Holding GUI (Fully Implemented)
- `SigilHoldingMenu.java` - Item-based container menu for 5 sigil slots
  - Prevents moving the holding sigil itself
  - Saves inventory on close and on every change
  - Validates only sigil items can be placed (no nested holding sigils)
- `SigilHoldingScreen.java` - GUI screen matching 1.20.1 texture layout
  - 5 slots spaced 36 pixels apart
  - Click any slot to select it as active
  - Selection indicator from texture sprite
- `SigilHoldingSelectionPayload.java` - Network payload for client->server sync
- `BMPayloads.java` - Centralized payload registration
- `ItemSigilHolding.java` - Updated to open GUI on shift+right-click
  - Uses `player.openMenu()` with data sync to client
  - Proper server-side menu opening

---

## Code Cleanup

### Deleted Files
- `TestMultiblock.java` - Was Patchouli-specific test code

### Renamed
- `EnumRuneType.patchouliColor` → `EnumRuneType.bookColor` (in util package)

---

## Anointment System

### Core Infrastructure
- `Anointment.java` - Core class defining anointment types with effects and consumption triggers
- `AnointmentRegistrar.java` - Registry of 13 anointment types
- `AnointmentEventHandler.java` - Event handlers for damage, durability, and tooltips
- `ItemAnointmentProvider.java` - Item class for applying anointments to tools/weapons
- `AnointmentHolder.java` - Data component for storing anointments on items

### Anointments Implemented (13 types, 59 item variants)
- Melee Damage (Honing Oil) - Bonus damage to attacks
- Silk Touch (Soft Coating) - Silk touch effect
- Fortune (Fortuna Extract) - Fortune effect
- Holy Water - Bonus damage vs undead
- Hidden Knowledge (Miner's Secrets) - Bonus XP from blocks
- Quick Draw (Dexterity) - Faster bow draw
- Looting (Plunderer's Glint) - Looting effect
- Bow Power (Iron Tip) - Bonus arrow damage
- Will Power (Alkahest) - Bonus from demon will
- Smelting (Slow-burning Oil) - Auto-smelt drops
- Voiding (Void Essence) - Destroy mundane drops
- Bow Velocity - Faster arrows
- Weapon Repair (Repairing Salve) - Repair on use

---

## Tau Blocks (Crop System)

### Blood-Powered Crops
- `BlockTau.java` - Extends CropBlock with 8 growth stages
- **Weak Tau**: Grows normally, 20% chance to transform to Strong Tau when damaging entities
- **Strong Tau**: Only grows when successfully damaging nearby living entities
- Deals 2 cactus damage to entities in 1-block radius during growth tick
- Custom loot tables with Fortune bonus for seeds

---

## Incense Altar System (Tag-Based Reimplementation)

### Tag-Based Path Blocks
- Migrated from `IIncensePath` interface to block tags
- 11 path level tags (`neovitae:incense_path/level_0` through `level_10`)
- Higher level tags inherit from lower levels (level_0 blocks work for all rings)
- Default blocks: Dirt Path, Stone Bricks
- Fully datapack-configurable

### Tranquility System
- 7 tranquility type tags (plant, crop, tree, earthen, water, fire, lava)
- `TranquilityRegistry.java` - Tag-based detection with vanilla fallbacks
- Automatic detection for common blocks (crops, logs, leaves, water, lava, fire)
- Custom blocks addable via datapacks

### Core Components
- `EnumTranquilityType.java` - Tranquility categories
- `TranquilityStack.java` - Tranquility value holder
- `IncenseAltarHandler.java` - Bonus calculation with tier system
- `IncenseHelper.java` - Player incense management via data attachments
- `BlockIncenseAltar.java` - The altar block
- `IncenseAltarTile.java` - Tile entity with road scanning and tranquility calculation

### Bonus Tiers
- 0 roads: 20% max bonus
- 1 road: 60% max bonus
- 4 roads: 120% max bonus
- 6 roads: 200% max bonus
- 8 roads: 300% max bonus
- 10 roads: 450% max bonus

---

## Soul Fray Mechanic

### Ceremonial Sacrifice Debuff
- `SoulFrayEffect.java` - Harmful effect preventing ceremonial sacrifice
- Duration: 400 ticks (20 seconds)
- Applied after successful ceremonial sacrifice (incense-boosted)
- While active, player can only perform normal 1-heart sacrifice
- Prevents rapid chaining of large sacrifices for balance

### Integration
- Updated `SacrificialDaggerItem.java` to apply and check for Soul Fray
- Clears incense bonus after ceremonial sacrifice
- Falls back to normal sacrifice when Soul Fray is active

---

## Bug Fixes

### Multiblock Validation
- Fixed server crash when multiblock validators weren't cleared on server stop
- Original issue: "world crashing because it 'already exists'" on repeat joins

### Demon Crucible & Tartaric Gems
- Fixed tartaric gems changing will type when placed in demon crucible
- Root cause: SoulGemItem methods allowed DEFAULT gems to be treated as any type
- Fixed `getWill()` to only return will if type matches exactly
- Fixed `drainWill()` to only allow draining matching type and preserve gem type
- Fixed `fillWill()` to only allow filling if gem is empty or type matches
- Fixed `getMaxWill()` to only return max for matching type if gem has will
- Empty gems can now only be filled with DEFAULT (raw) will type via crucible

### Texture Corruption
- Fixed corrupted demon crystal textures (were 14-byte placeholder files)
- Downloaded valid PNG textures from 1.20.1 repository for all 5 crystal types
- Fixed corrupted incense altar texture (same issue)
- All OBJ model textures now properly load

---

## Routing Node System

### GUI System
- `RoutingNodeMenu.java` - Container menu for filtered routing nodes
  - 6 filter slots per node with ghost item support
  - Priority and amount configuration per slot
  - ContainerData synchronization for client/server state
- `RoutingNodeScreen.java` - GUI screen for routing node configuration
- `MasterRoutingNodeMenu.java` - Container menu for master routing node
  - Displays connected nodes and their status
  - Ghost slot filtering for node management
- `MasterRoutingNodeScreen.java` - GUI for master routing node overview

### Network Payloads
- `RoutingNodePayload.java` - Packet for routing node configuration changes
- `MasterRoutingNodePayload.java` - Packet for master node commands
- Added security validation (distance check, menu verification) to prevent remote exploitation

### Bug Fixes (Code Review)
- Fixed NPE in `RoutingNodeMenu` constructor when block entity not found
- Fixed NPE in `MasterRoutingNodeMenu` constructor with null-safe lookup
- Added null level checks in `FilteredRoutingNodeTile` methods
- Optimized `MasterRoutingNodeTile.tick()` to skip client-side execution
- Changed path-finding from O(n) List to O(1) HashSet for visited nodes

### Thread Safety Fixes
- `PlayerHelper.knownFakePlayers`: Changed from `ArrayList` to `CopyOnWriteArrayList`
- `HarvestRegistry`: All collections now use concurrent implementations
  - `HARVEST_HANDLERS`: `CopyOnWriteArrayList`
  - `STANDARD_CROPS`, `AMPLIFIERS`: `ConcurrentHashMap`
  - `TALL_CROPS`: `ConcurrentHashMap.newKeySet()`
  - `STEM_CROPS`: `Multimaps.synchronizedMultimap()`
- `TagsCache`: Added `volatile` to `TOOLTIP_ORDER` and `UPGRADE_SCRAPPABLE` fields

---

## Ritual Events API

### Event System
- `RitualEvent.java` - Base event class for ritual lifecycle hooks
- `RitualEvent.Activate` - Fired before ritual activation (cancellable)
- `RitualEvent.Activated` - Fired after successful activation
- `RitualEvent.Perform` - Fired before each ritual tick (cancellable)
- `RitualEvent.Stop` - Fired when ritual stops (not cancellable)

### Integration Points
- All events fire from `MasterRitualStoneTile` central methods
- Allows mods to hook into ritual lifecycle
- Cancel activation to prevent rituals from starting
- Cancel perform to skip individual tick cycles

---

## Admin Commands

### Soul Network Command (`/bm-network`)
- `/bm-network <player> query` - Display player's current LP
- `/bm-network <player> set <amount>` - Set LP to exact value
- `/bm-network <player> add <amount>` - Add LP to network
- `/bm-network <player> reset` - Reset LP to zero

### Ritual Command (`/bm-ritual`)
- `/bm-ritual <pos> info` - Display ritual information at position
- `/bm-ritual <pos> stop` - Force stop the active ritual
- `/bm-ritual <pos> set <ritual_id>` - Force activate ritual (bypasses cost/structure)
- `/bm-ritual <pos> cooldown <ticks>` - Set ritual cooldown
- `/bm-ritual list` - List all registered rituals with crystal level and cost

### Living Upgrade Command (`/living-upgrade`)
- `/living-upgrade <player> upgrade set <id> <exp>` - Set upgrade experience
- `/living-upgrade <player> upgrade get [id]` - Show upgrade levels
- `/living-upgrade <player> limits set <id> <max>` - Set max level for upgrade
- `/living-upgrade <player> limits mode allow|deny` - Set limit mode
- `/living-upgrade <player> points recalc` - Recalculate upgrade points
- `/living-upgrade <player> points set-cap <amount>` - Set upgrade point cap

### Command Features
- All commands require operator permissions (level 2+)
- Tab completion for player names, ritual IDs, and upgrade IDs
- Works from console where applicable
- `forceActivateRitual()` method added to `MasterRitualStoneTile`

---

## Demon Will System Fixes

### Tartaric Gem Auto-Fill
- Monster souls now automatically absorb into tartaric gems on pickup
- Added `ItemEntityPickupEvent.Pre` handler in `WillEventHandler`
- If gems are full, souls go to inventory as normal
- Partial absorption supported (fills gems, remainder stays as item)

### Demon Crucible Redstone Control
- **Without redstone signal**: Extracts will from gems and releases to chunk aura
- **With redstone signal**: Absorbs will from chunk aura into gems
- Allows automated will storage and retrieval systems
- Monster souls and crystals only function without redstone (output mode)
- Fill rate: 0.5 will per second (same as drain rate)

---

## Code Cleanup

### TODO Comments Resolved
- Removed outdated "ritual system implementation pending" comment (BMBlocks.java)
- Removed outdated "tau functionality" comment (BMItems.java)
- Removed unnecessary tag suggestion comment (BMTabs.java)
- Updated BlockRitualStone comment to reflect complete implementation
- Converted design consideration to Note in LivingEventHandler

---

## Experience Tome (Tome of Peritia)

### Core Implementation
- `ExperienceTomeItem.java` - Item for storing player XP
  - Shift+Right-click stores one level, Right-click retrieves one level
  - Hold to store/retrieve multiple levels
  - When equipped as Curio charm, automatically absorbs XP orbs

### Curio Integration
- Registered as valid `charm` curio slot
- `CuriosCompat` updated with capability registration
- Auto-absorption feature when worn in curio slot

### Ritual Integration
- Ritual of the Zephyr collects XP orbs into equipped Tome of Peritia
- XP stored directly without player interaction

---

## Data-Driven Systems

### Sigil Stats DataMap
- `SigilStats.java` - Record for sigil properties with Codec serialization
  - `lp_cost`: LP consumed on activation
  - `drain_interval`: Ticks between drain (for toggleable sigils)
  - `range`: Horizontal effect range
  - `vertical_range`: Vertical effect range
  - `effect_duration`: Duration of applied effects
  - `effect_level`: Level/strength of effects
- `SigilStatsProvider.java` - Generates individual JSON files per sigil
- Individual files at `data/bloodmagic/data_maps/item/sigil_stats/<sigil_name>.json`
- `ItemSigil.getLpUsed()` now reads from datamap, falling back to constructor value
- `ItemSigilToggleable.getDrainInterval()` reads from datamap for drain timing
- Fully datapack-customizable - modpack makers can add/override individual sigil files

### Ritual Stats DataMap
- `RitualStats.java` - Record for ritual properties with Codec serialization
  - `activation_cost`: LP to activate ritual
  - `refresh_cost`: LP per refresh tick
  - `refresh_time`: Ticks between refreshes
  - `crystal_level`: Required crystal tier (0=weak, 1=standard, 2=awakened)
  - `range_limits`: Map of named area limits (max volume, horizontal/vertical radius)
- `RitualStatsProvider.java` - Generates individual JSON files per ritual (35 files)
- Individual files at `data/bloodmagic/data_maps/bloodmagic/ritual/ritual_stats/<ritual_name>.json`
- Fully datapack-customizable - modpack makers can add/override individual ritual files

### DataMap Registration
- Updated `BMDataMaps.java` with SIGIL_STATS and RITUAL_STATS types
- Both maps synced to client for proper rendering/UI

---

## Blood Altar Improvements

### Capacity Grace Period
- Added 5-second grace period when altar structure changes
- Prevents fluid loss when temporarily breaking runes during reconfiguration
- `capacityGraceTicks` counter starts when capacity decreases
- Tank contents are only clamped to new capacity after grace period expires
- Grace period persists through world save/load

---

## Fluid Routing System

### New Fluid Routing Interfaces
- `IFluidFilter.java` - Interface for fluid filters (mirrors IItemFilter)
- `IFluidRoutingNode.java` - Base interface for fluid routing nodes
- `IInputFluidRoutingNode.java` - Interface for fluid input nodes
- `IOutputFluidRoutingNode.java` - Interface for fluid output nodes

### Fluid Filter Implementation
- `BasicFluidFilter.java` - Whitelist filter for fluid transfer
  - Tracks requested fluid amounts per type
  - Handles tank context for input/output operations
  - Supports partial transfers and remainder tracking

### Master Routing Node Updates
- Added fluid input/output node tracking lists
- Added `getMaxFluidTransfer()` method (1000 mB base + 1000 mB per upgrade)
- Fluid routing runs after item routing each tick
- Fluid nodes automatically registered when connecting to network
- Full NBT save/load for fluid node lists

---

## Block Protection Helper

### Anti-Griefing Protection System
- `BlockProtectionHelper.java` - Utility class for safe block operations
- Fires `BlockEvent.BreakEvent` and `BlockEvent.EntityPlaceEvent` before modifying blocks
- Allows protection mods (FTB Chunks, etc.) to cancel block modifications
- Supports both Player-based and UUID-based protection checks
- UUID methods allow rituals and machines to check against owner's permissions

### Methods Available:
- `tryBreakBlock()` / `tryBreakBlockNoDrops()` - Safe block breaking
- `tryPlaceBlock()` - Safe block placement with protection checks
- `tryReplaceBlock()` - Safe block replacement (break + place)
- `tryRemoveBlock()` - Safe block removal (set to air)
- `canBreakBlock()` / `canPlaceBlock()` - Pre-check without modification
- `fireBreakEvent()` / `firePlaceEvent()` - Manual event firing

### Updated Block Modifiers:

**Rituals:**
- `BlockRitualStone.setRuneType()` - Now accepts optional Player for protection
- `ItemRitualDiviner` - Checks protection before placing ritual stones
- `RitualWater` - Checks protection before placing water
- `RitualLava` - Checks protection before placing lava
- `RitualFelling` - Checks protection before breaking logs/leaves
- `RitualPump` - Checks protection before removing fluid sources
- `RitualPlacer` - Checks protection before placing blocks
- `RitualCrushing` - Checks protection before crushing blocks
- `RitualSuppression` - Checks protection before suppressing fluids
- `RitualSphere` - Checks protection before placing sphere blocks
- `RitualPhantomBridge` - Checks protection before placing phantom bridge blocks
- `RitualMeteor` - Checks protection before placing meteor blocks
- `RitualGeode` - Checks protection before growing crystals
- `RitualEllipse` - Checks protection before placing ellipsoid blocks
- `RitualCrystalHarvest` - Checks protection before harvesting crystals
- `RitualCrystalSplit` - Checks protection before splitting crystals
- `RitualHarvest` - Passes owner UUID to harvest handlers

**Harvest Handlers:**
- `IHarvestHandler` - Interface updated to accept owner UUID parameter
- `HarvestHandlerPlantable` - Checks protection before replanting crops
- `HarvestHandlerStem` - Checks protection before harvesting pumpkins/melons
- `HarvestHandlerTall` - Checks protection before harvesting sugarcane/cactus/bamboo
- `HarvestHandlerNetherWart` - Checks protection before replanting nether wart
- `HarvestHandlerBerryBush` - Checks protection before resetting berry bushes
- `HarvestHandlerGrowingPlant` - Checks protection before harvesting kelp/vines

**Sigils:**
- `ItemSigilSuppression` - Checks protection before replacing fluids with spectral blocks
- `ItemSigilFrost` - Checks protection before freezing water to ice
- `ItemSigilFluidBase` - Checks protection before placing fluids
- `ItemSigilBloodLight` - Checks protection before placing blood lights directly
- `EntityBloodLight` - Checks protection before placing blood lights (tracks owner UUID)

**Other Block Modifiers:**
- `ItemArcaneAshes` - Checks protection before placing alchemy arrays
- `TileImperfectRitualStone` - Checks protection before destroying catalyst block

---

## Quality of Life Improvements (PR #2128)

### Upgrade Tome Combining
- `UpgradeTomeCombineRecipe.java` - Custom crafting recipe for combining tomes
- Two Upgrade Tomes of the same type can be combined in a crafting grid
- Merges their experience together for consolidation
- `UpgradeTomeCombineSerializer.java` - Recipe serializer with MapCodec/StreamCodec
- Registered as `neovitae:upgrade_tome_combine` recipe type

### ARC In-World Tank Interaction
- Right-click ARC with fluid container (bucket, etc.) for direct tank interaction
- Priority order: Fill input tank → Empty output tank → Empty input tank → Open GUI
- Plays appropriate bucket fill/empty sounds
- If no fluid interaction possible, opens GUI normally

---

## Ritual Diviner & Activation Crystal Fixes

### Ritual Activation Best-Match Logic
- Fixed ritual activation selecting wrong ritual when multiple patterns overlap
- Now finds the most specific ritual match (highest component count)
- Prevents smaller rituals from activating when a larger ritual structure is present

### Ritual Diviner Improvements
- Fixed cycling through rituals continuing while mouse button held
- Added cooldown system using Minecraft's item cooldown mechanism
- Fixed client/server desync on ritual cycling via `inventoryMenu.broadcastChanges()`
- Removed duplicate event handlers from `CommonEventHandler.java`
- Fixed right-click on MRS not placing stones (handled in block interaction now)
- Diviner stone placement now works with normal right-click (shift+right-click reserved for cycling)

### Activation Crystal Animation
- Added `use()` method to `ItemActivationCrystal` for arm swing animation on binding

---

## Item Fixes

### Lava Crystal Reimplementation
- Created proper `ItemLavaCrystal.java` class (was just basic Item)
- Implements `IBindable` for player binding support
- Right-click to place fire (costs 100 LP, damages player if insufficient)
- Works as furnace fuel when bound (200 ticks burn time, costs 50 LP)
- Returns itself after crafting use (reusable)
- Added tooltip explaining functionality

### Filled Tartaric Gems in Creative Menu
- Added pre-filled tartaric gems to the creative menu (Raw will type)
- All 5 gem tiers available filled to max capacity:
  - Petty (64 will), Lesser (256), Common (1024), Greater (4096), Grand (16384)

### Sentient Weapon Tooltips
- Added missing tooltip lang keys for all sentient tools:
  - `tooltip.bloodmagic.sentientSword.desc`
  - `tooltip.bloodmagic.sentientAxe.desc`
  - `tooltip.bloodmagic.sentientPickaxe.desc`
  - `tooltip.bloodmagic.sentientShovel.desc`
  - `tooltip.bloodmagic.sentientScythe.desc`
- Tooltips explain that tools are empowered by demon will in inventory

---

## Texture Fixes

### Demon Will Blocks (OBJ Models)
- Fixed broken textures for Demon Crystallizer and Demon Crucible
- Renamed MTL files to match OBJ references (underscore removal)
- `block_demon_crystallizer.mtl` → `blockdemoncrystallizer.mtl`
- `block_demon_crucible.mtl` → `blockdemoncrucible.mtl`

### Teleposer Focus Items
- Fixed broken textures for all teleposer focus items
- Renamed model files to match item registry names (underscore addition)
- `teleposerfocus.json` → `teleposer_focus.json` (etc.)

### Incense Altar
- Added proper OBJ model and texture from 1.20.1 (was using placeholder cube)
- Downloaded `blockincensealtar.obj`, `blockincensealtar.mtl`, and `incensealtar.png`
- Fixed texture path - moved from `models/` to `textures/models/incensealtar.png`
- Fixed MTL file to use `#default` texture reference (matching NeoForge OBJ loader format)

### Demon Crystal Blocks
- Added proper OBJ models for all 5 crystal types (raw, corrosive, destructive, vengeful, steadfast)
- Downloaded crystal1.obj model and color-coded textures for each will type
- Crystals now render as 3D crystal spires instead of placeholder cubes
- Fixed OBJ texture mapping by adding `Material.001` key to match MTL material name

### Lava Crystal
- Created item model `lava_crystal.json` (was missing, causing broken texture)

### Sentient Sword Active State
- Added item property `neovitae:active` for sword texture switching
- Sword shows deactivated texture when no demon will available
- Sword shows activated texture when player has demon will in inventory
- Downloaded `soul_sword_activated.png` texture

### Sentient Tool Will Type Properties
- Added `neovitae:will_type` item property for all sentient tools
- Sword, axe, pickaxe, shovel, and scythe all register will type property
- Enables texture switching based on current will type (future enhancement)

### Sentient Sword Dynamic Scaling
- Fixed sentient sword damage and attack speed not scaling with demon will
- Added `getAttributeModifiers` override that dynamically updates based on will type/amount
- Added `inventoryTick` to recalculate stats every second when sword is selected
- Destructive will = highest damage but slowest attack
- Vengeful will = fastest attack but lower damage
- Default/Steadfast = balanced stats
- Attack power scales through 7 tiers based on will amount (16, 60, 200, 400, 1000, 2000, 4000)

---

## Progression Advancements (PR #1995)

### Blood Orb Progression
- Root advancement: Obtain a Blood Altar
- Weak Blood Orb → Apprentice → Magician → Master → Archmage progression chain
- Higher tier orbs use goal/challenge frames for visual distinction

### Demon Will Progression
- Soul Snare → Demon Will → Soul Sword branch
- Tartaric Gem progression: Petty → Lesser → Common → Greater → Grand
- Hellfire Forge → Demon Crucible branch

### Other Advancements
- Ritual Diviner (branches from Apprentice Blood Orb)
- Living Armor (branches from Magician Blood Orb)

---


## Curios API Integration

### Curio Slots for Blood Magic Items
- `CuriosCompat.java` - Main integration class with safe Curios detection
- **Charm slot**: Sigils (mining, growth, magnetism, ice, holding, divination, seer, suppression), experience book, demon will gauge
- **Necklace slot**: Tartaric gems (petty, lesser, common, greater)
- **Bracelet slot**: Training bracelet
- **Living Armour Socket slot**: Custom slot for all Blood Magic curios, starts at 0 size

### Living Armour Socket Upgrade
- CURIOS_SOCKET upgrade re-enabled in `LivingUpgrades.java`
- 5 levels available (10, 30, 70, 150, 310 experience cost)
- Each level adds one Living Armour Socket slot (up to 5 total)
- Slots dynamically added/removed when equipping/unequipping living armor

### Data Files Created
- `data/curios/tags/items/charm.json` - Items for charm slot
- `data/curios/tags/items/necklace.json` - Items for necklace slot
- `data/curios/tags/items/bracelet.json` - Items for bracelet slot
- `data/curios/tags/items/living_armour_socket.json` - All curio items
- `data/bloodmagic/curios/slots/living_armour_socket.json` - Custom slot definition
- `data/bloodmagic/curios/entities/bmplayerslots.json` - Player slot assignments
- `assets/bloodmagic/textures/item/curios_empty_living_armour_socket.png` - Empty slot icon

---

## Additional Events API

### Crafting Events
- `BloodAltarCraftEvent.java` - Events for Blood Altar crafting
  - `Crafting` (cancellable) - Before craft completes, can modify output
  - `Crafted` - After successful craft
- `AlchemyArrayCraftEvent.java` - Events for Alchemy Array crafting
  - `Crafting` (cancellable) - Before craft completes, can modify output
  - `Crafted` - After successful craft
- `ImperfectRitualEvent.java` - Events for Imperfect Rituals
  - `Activate` (cancellable) - Before ritual activates
  - `Activated` - After successful activation

---

## Command Improvements

### Aura Command (`/bm-aura`)
- `/bm-aura get [type|all]` - Display demon will in current chunk
- `/bm-aura set <type|all> <amount>` - Set will amount (clamped 0-100)
- `/bm-aura add <type|all> <amount>` - Add/subtract will (result clamped)
- `/bm-aura clear` - Remove all will from chunk

### Parent Command (`/bloodmagic`)
- Added `/bloodmagic` as parent command with subcommand aliases
- `/bloodmagic network` → `/bm-network`
- `/bloodmagic ritual` → `/bm-ritual`
- `/bloodmagic aura` → `/bm-aura`
- `/bloodmagic upgrade` → `/living-upgrade`
- Original standalone commands still work

---

## Dungeon Dimension System (In Progress)

### Dimension Infrastructure
- Created `neovitae:dungeon` dimension with void generation
  - `dimension_type/dungeon.json` - Fixed time at 18000 (night), no raids
  - `dimension/dungeon.json` - Noise generator with fixed biome
  - `worldgen/biome/dungeon_void.json` - Empty void biome
  - `worldgen/noise_settings/dungeon_void.json` - Air-only generation

### Dungeon Helper Classes
- `DungeonDimensionHelper.java` - Utility class for dimension operations
  - `getDungeonWorld()` - Access dungeon ServerLevel
  - `teleportToDungeon()` / `teleportFromDungeon()` - Player teleportation
  - `DUNGEON_DIMENSION` ResourceKey for dimension access

### World Saved Data Extensions
- Extended `BMSavedData.java` with dungeon tracking
  - `numberOfDungeons` counter with serialization
  - `getNextDungeonSpawnPosition()` - Spiral grid algorithm
  - Dungeons spaced 1000 blocks apart to prevent overlap
- Extended `SoulNetworkHelper.java` with dungeon methods
  - `getSpawnPositionOfDungeon()`, `incrementDungeonCounter()`, `getNumberOfDungeons()`

### Inversion Pillar Improvements
- Updated `TileInversionPillar.java` for proper teleportation
  - Added convenience method `setDestination(Level, BlockPos)`
  - Changed from command-based to proper `player.teleportTo()` API
  - Full NBT serialization for destination position and dimension

### Simple Dungeon Ritual
- `RitualSimpleDungeon.java` - "Edge of the Hidden Realm" ritual
  - Creates portal to mini-dungeon in dungeon dimension
  - Spawns bidirectional inversion pillars
  - Stores player exit location in persistent data
  - Creates placeholder stone brick platform (full generation pending)
  - Replaces ritual runes with smooth stone after activation
- Registered as `simple_dungeon` in `BMRituals.java`

### Standard Dungeon Ritual
- `RitualStandardDungeon.java` - "Pathway to the Endless Realm" ritual
  - Higher-tier ritual (150,000 LP activation, requires DUSK runes)
  - Creates larger entrance room with decorative pillars and lighting
  - Portal pillar positioned 4 blocks up (vs 2 for simple dungeon)
  - Complex multi-tier rune pattern spanning 6 levels vertically
  - Full procedural generation pending (DungeonSynthesizer)
- Registered as `standard_dungeon` in `BMRituals.java`

### Constants
- Added dungeon-related NBT keys to `Constants.java`
  - `DUNGEON_EXIT`, `DUNGEON_TELEPORT_POS`, `DUNGEON_TELEPORT_KEY`
  - `DOOR_MAP`, `AREA_DESCRIPTORS`, `ROOM_POOL`, `ROOM_POOL_BUFFER`, `ROOM_POOL_TRACKER`, `VALUE`

### Procedural Generation System
- Complete `structures` package for dungeon generation:
  - `DungeonStructure.java` - NBT template placement wrapper
  - `DungeonUtil.java` - Rotation/direction utilities
  - `DungeonDoor.java` - Door connection data with room pool references
  - `DungeonRoom.java` - Room definitions with doors, areas, structures
  - `DungeonRoomRegistry.java` - Room and pool registration with weighted selection
  - `DungeonRoomLoader.java` - JSON room/pool loading from assets
  - `ModRoomPools.java` - Room pool resource location constants
  - `DungeonSynthesizer.java` - Core procedural generation orchestrator
  - `SpecialDungeonRoomPoolRegistry.java` - Special room progression tracking
  - `StoneToOreProcessor.java` - Structure processor for ore generation
  - `rooms/DungeonRoomPlacement.java` - Pending room placement data
- Extended `AreaDescriptor.java` with `intersects()` and `offset()` methods
- Created `gson/` package for JSON serialization:
  - `Serializers.java` - Custom serializers for BlockPos, Direction, ResourceLocation
  - `SerializerBase.java` - Base serializer interface

### Dungeon Controller System
- `BlockDungeonController.java` - Unbreakable control block placed at dungeon spawn
- `TileDungeonController.java` - Manages DungeonSynthesizer, handles room placement requests
- `BlockDungeonSeal.java` - Sealed doors with light glow (light level 7)
- `TileDungeonSeal.java` - Stores controller/door info, requests room generation on interaction
- Registered in `BMBlocks.java` and `BMTiles.java`
- Added dungeon seal translation keys to `BMLanguageProvider.java`
- Extended `DungeonDoor.java` with `getPotentialRoomTypes()` getter
- Extended `DungeonRoomPlacement.java` with room placement and seal creation methods
- Added additional NBT keys to `Constants.java` (CONTROLLER_POS, DOOR_POS, DOOR_DIRECTION, etc.)

### Dungeon Key Items
- `ItemDungeonKey.java` - Base class for dungeon keys with room pool matching
  - `getValidResourceLocation()` - Filters and randomly selects matching room pools
  - `canOpenDoor()` - Checks if key matches seal's potential rooms
- Updated key registrations in `BMItems.java` to use ItemDungeonKey:
  - `SIMPLE_KEY` - Opens simple corridors and hallways
  - `MINE_KEY` - Opens mine tunnels and caves
  - `MINE_ENTRANCE_KEY` - Opens mine entrances
  - `STANDARD_KEY` - Opens standard rooms and chambers
  - `BOSS_KEY` - Opens boss/special/treasure rooms
- Updated `BlockDungeonSeal.java` - Added useItemOn() handler for dungeon keys
- Updated `TileDungeonSeal.java` - Added requestRoomFromControllerWithKey() method
- Added translation keys for all dungeon key items and tooltips

### NBT Structure Templates (Ported from 1.20.1)
- 48 structure template files ported to `data/bloodmagic/structures/`
- Root level (7 files): four_way_corridor, four_way_corridor_loot, overlapped_corridor, spiral_staircase, straight_corridor, t3_entrance, t_corridor
- `mines/` subdirectory (1 file): mine_key
- `mini_dungeon/` subdirectory (5 files): armoury, crypt, farm, library, portal_nether
- `standard/` subdirectory (35 files): Complete set including mine structures, libraries, arenas, entrances, loot rooms, traps, decorative structures

---

*Last updated: December 9, 2025*
